---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import ArticleCard from '../../components/ArticleCard.astro';

export async function getStaticPaths() {
  const allPosts = await getCollection('posts');
  const categories = [...new Set(allPosts.map((p) => p.data.category))];

  return categories.map((category) => ({
    params: { category },
    props: {
      posts: allPosts
        .filter((p) => p.data.category === category)
        .sort((a, b) => b.data.date.getTime() - a.data.date.getTime()),
    },
  }));
}

const { category } = Astro.params;
const { posts } = Astro.props;
---

<BaseLayout
  title={`${category} — カテゴリ別記事一覧`}
  description={`「${category}」カテゴリの記事一覧。日本史・戦国時代に関する${category}の記事を${posts.length}本掲載しています。`}
>
  <div class="container">
    <nav class="breadcrumb" aria-label="パンくずリスト">
      <a href="/">ホーム</a>
      <span aria-hidden="true">›</span>
      <a href="/blog/">記事一覧</a>
      <span aria-hidden="true">›</span>
      <span aria-current="page">{category}</span>
    </nav>

    <header class="page-header">
      <div class="category-label" aria-hidden="true">{category}</div>
      <h1 class="page-title">「{category}」の記事一覧</h1>
      <p class="page-desc">{posts.length} 記事</p>
    </header>

    {posts.length > 0 ? (
      <ul class="article-grid" role="list">
        {posts.map((post) => (
          <li>
            <ArticleCard
              title={post.data.title}
              description={post.data.description}
              date={post.data.date}
              category={post.data.category}
              tags={post.data.tags}
              thumbnail={post.data.thumbnail}
              slug={post.id.replace(/\.md$/, '')}
            />
          </li>
        ))}
      </ul>
    ) : (
      <p class="empty">このカテゴリの記事はまだありません。</p>
    )}

    <nav class="back-nav">
      <a href="/blog/" class="back-link">← すべての記事を見る</a>
    </nav>
  </div>
</BaseLayout>

<style>
  .breadcrumb {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--color-nezumi);
    margin-bottom: var(--spacing-xl);
    flex-wrap: wrap;
  }

  .breadcrumb a {
    color: var(--color-nezumi);
  }

  .breadcrumb a:hover {
    color: var(--color-ake);
  }

  .page-header {
    margin-bottom: var(--spacing-xl);
  }

  .category-label {
    display: inline-block;
    background: var(--color-ake);
    color: var(--color-shiro);
    font-size: 0.8125rem;
    font-weight: 700;
    padding: 0.2em 0.75em;
    border-radius: 2px;
    margin-bottom: var(--spacing-sm);
  }

  .page-title {
    font-family: var(--font-serif);
    font-size: 1.75rem;
    color: var(--color-sumi);
    margin-bottom: 0.25rem;
  }

  .page-desc {
    font-size: 0.9375rem;
    color: var(--color-nezumi);
  }

  .article-grid {
    list-style: none;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-xl);
  }

  .empty {
    text-align: center;
    color: var(--color-nezumi);
    padding: var(--spacing-2xl);
  }

  .back-nav {
    margin-top: var(--spacing-xl);
    padding-top: var(--spacing-lg);
    border-top: 1px solid var(--color-border);
  }

  .back-link {
    color: var(--color-ake);
    font-size: 0.9375rem;
    font-weight: 500;
  }

  .back-link:hover {
    text-decoration: underline;
  }
</style>
